# è´¦æˆ·åˆ é™¤åŠŸèƒ½é…ç½®æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

è´¦æˆ·åˆ é™¤åŠŸèƒ½å…è®¸ç”¨æˆ·æ°¸ä¹…åˆ é™¤å…¶è´¦æˆ·åŠæ‰€æœ‰ç›¸å…³æ•°æ®ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤ä»¥é˜²æ­¢è¯¯æ“ä½œã€‚

## ğŸ¯ å®ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´¦æˆ·åˆ é™¤æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢ç‚¹å‡» "åˆ é™¤è´¦æˆ·"                             â”‚
â”‚              â†“                                              â”‚
â”‚  2. å¼¹å‡ºç¬¬ä¸€æ¬¡ç¡®è®¤å¯¹è¯æ¡†                                     â”‚
â”‚              â†“                                              â”‚
â”‚  3. ç”¨æˆ·ç¡®è®¤åï¼Œå¼¹å‡ºæœ€ç»ˆç¡®è®¤å¯¹è¯æ¡†ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰                â”‚
â”‚              â†“                                              â”‚
â”‚  4. iOS å®¢æˆ·ç«¯è°ƒç”¨ Edge Functionï¼ˆå¸¦ä¸Š accessTokenï¼‰         â”‚
â”‚              â†“                                              â”‚
â”‚  5. Edge Function éªŒè¯ç”¨æˆ·èº«ä»½                               â”‚
â”‚              â†“                                              â”‚
â”‚  6. ä½¿ç”¨ service_role key è°ƒç”¨ auth.admin.deleteUser()      â”‚
â”‚              â†“                                              â”‚
â”‚  7. æ•°æ®åº“çº§è”åˆ é™¤ç”¨æˆ·ç›¸å…³æ•°æ®ï¼ˆå¦‚æœå·²é…ç½®ï¼‰                  â”‚
â”‚              â†“                                              â”‚
â”‚  8. è¿”å›æˆåŠŸï¼ŒiOS æ¸…é™¤æœ¬åœ°çŠ¶æ€å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ é…ç½®æ­¥éª¤

### 1. éƒ¨ç½² Edge Function

#### 1.1 å®‰è£… Supabase CLIï¼ˆå¦‚æœè¿˜æœªå®‰è£…ï¼‰

```bash
# macOS
brew install supabase/tap/supabase

# å…¶ä»–å¹³å°å‚è€ƒï¼šhttps://supabase.com/docs/guides/cli
```

#### 1.2 ç™»å½•åˆ° Supabase

```bash
supabase login
```

#### 1.3 é“¾æ¥åˆ°æ‚¨çš„é¡¹ç›®

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/zhaoyunxia/Desktop/EarthLord

# é“¾æ¥åˆ°é¡¹ç›®ï¼ˆéœ€è¦è¾“å…¥é¡¹ç›®å¼•ç”¨IDï¼Œå¯ä»¥åœ¨ Supabase Dashboard æ‰¾åˆ°ï¼‰
supabase link --project-ref YOUR_PROJECT_REF
```

æ‚¨å¯ä»¥åœ¨ Supabase Dashboard çš„é¡¹ç›®è®¾ç½®ä¸­æ‰¾åˆ° Project Refï¼š
- ç™»å½• https://supabase.com/dashboard
- é€‰æ‹©æ‚¨çš„é¡¹ç›®
- Settings â†’ General â†’ Reference ID

#### 1.4 éƒ¨ç½² Edge Function

```bash
# éƒ¨ç½² delete-account å‡½æ•°
supabase functions deploy delete-account

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
supabase functions list
```

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨ä¼šçœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
```
Deployed Functions:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name            â”‚ URL                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ delete-account  â”‚ https://xxx.supabase.co/functions/v1/...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰

Edge Function ä¼šè‡ªåŠ¨ä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰ï¼š
- `SUPABASE_URL` - æ‚¨çš„ Supabase é¡¹ç›® URL
- `SUPABASE_SERVICE_ROLE_KEY` - Service Role Keyï¼ˆå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼‰

è¿™äº›ç¯å¢ƒå˜é‡åœ¨ Supabase å¹³å°ä¸Šå·²è‡ªåŠ¨é…ç½®ã€‚

### 3. æµ‹è¯• Edge Function

#### 3.1 åœ¨ Supabase Dashboard æµ‹è¯•

1. ç™»å½• Supabase Dashboard
2. è¿›å…¥ Edge Functions
3. é€‰æ‹© `delete-account` å‡½æ•°
4. ç‚¹å‡» "Invoke Function"
5. æ·»åŠ  Authorization headerï¼ˆä½¿ç”¨çœŸå®çš„ç”¨æˆ· access tokenï¼‰
6. å‘é€è¯·æ±‚

#### 3.2 ä½¿ç”¨ curl æµ‹è¯•

```bash
# æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å€¼
SUPABASE_URL="https://kmfuiegtfpqvcfkfzfzw.supabase.co"
ACCESS_TOKEN="ç”¨æˆ·çš„_access_token"

curl -X POST \
  "${SUPABASE_URL}/functions/v1/delete-account" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  -H "Content-Type: application/json"
```

é¢„æœŸå“åº”ï¼š
```json
{
  "success": true,
  "message": "è´¦æˆ·å·²æˆåŠŸåˆ é™¤"
}
```

### 4. é…ç½®æ•°æ®åº“çº§è”åˆ é™¤ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æœ‰å…¶ä»–è¡¨å¼•ç”¨äº† `auth.users` è¡¨ï¼Œéœ€è¦é…ç½®çº§è”åˆ é™¤ä»¥ç¡®ä¿ç”¨æˆ·åˆ é™¤æ—¶ç›¸å…³æ•°æ®ä¹Ÿè¢«åˆ é™¤ã€‚

#### 4.1 æŸ¥çœ‹ç°æœ‰è¡¨ç»“æ„

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- æŸ¥çœ‹æ‰€æœ‰å¼•ç”¨ auth.users çš„å¤–é”®
SELECT
    tc.table_schema,
    tc.table_name,
    kcu.column_name,
    ccu.table_schema AS foreign_table_schema,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name,
    rc.delete_rule
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
  AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
  AND ccu.table_schema = tc.table_schema
JOIN information_schema.referential_constraints AS rc
  ON rc.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND ccu.table_name = 'users'
  AND ccu.table_schema = 'auth';
```

#### 4.2 æ·»åŠ çº§è”åˆ é™¤

å¯¹äºæ¯ä¸ªéœ€è¦çº§è”åˆ é™¤çš„è¡¨ï¼Œæ‰§è¡Œç±»ä¼¼çš„ SQLï¼š

```sql
-- ç¤ºä¾‹ï¼šå‡è®¾ä½ æœ‰ä¸€ä¸ª user_profiles è¡¨
ALTER TABLE public.user_profiles
DROP CONSTRAINT IF EXISTS user_profiles_user_id_fkey,
ADD CONSTRAINT user_profiles_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES auth.users(id)
ON DELETE CASCADE;

-- ç¤ºä¾‹ï¼šå‡è®¾ä½ æœ‰ä¸€ä¸ª user_data è¡¨
ALTER TABLE public.user_data
DROP CONSTRAINT IF EXISTS user_data_user_id_fkey,
ADD CONSTRAINT user_data_user_id_fkey
FOREIGN KEY (user_id)
REFERENCES auth.users(id)
ON DELETE CASCADE;
```

âš ï¸ **é‡è¦æç¤º**ï¼š
- `ON DELETE CASCADE` ä¼šåœ¨ç”¨æˆ·åˆ é™¤æ—¶è‡ªåŠ¨åˆ é™¤ç›¸å…³æ•°æ®
- è¯·æ ¹æ®æ‚¨çš„å®é™…è¡¨ç»“æ„è°ƒæ•´çº¦æŸåç§°å’Œè¡¨å
- åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰ï¼Œè¯·å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

### 5. iOS å®¢æˆ·ç«¯é…ç½®ï¼ˆå·²å®Œæˆï¼‰

iOS å®¢æˆ·ç«¯çš„åŠŸèƒ½å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ï¼š

âœ… `AuthManager.deleteAccount()` - è°ƒç”¨ Edge Function åˆ é™¤è´¦æˆ·
âœ… `ProfileTabView` - åˆ é™¤è´¦æˆ· UI å’ŒäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
âœ… è¯¦ç»†çš„ä¸­æ–‡æ—¥å¿—ç”¨äºè°ƒè¯•

## ğŸ” è°ƒè¯•æŒ‡å—

### iOS ç«¯è°ƒè¯•

æ‰€æœ‰å…³é”®æ­¥éª¤éƒ½åŒ…å«ä¸­æ–‡æ—¥å¿—ï¼š

```
ğŸš¨ [è®¤è¯] å¼€å§‹åˆ é™¤è´¦æˆ·æµç¨‹
âœ… [è®¤è¯] å·²è·å–è®¿é—®ä»¤ç‰Œ
ğŸ”— [è®¤è¯] è°ƒç”¨åˆ é™¤è´¦æˆ· Edge Function
âœ… [è®¤è¯] Edge Function è°ƒç”¨æˆåŠŸ
ğŸ“ [è®¤è¯] å“åº”æ•°æ®: {"success":true,"message":"è´¦æˆ·å·²æˆåŠŸåˆ é™¤"}
âœ… [è®¤è¯] è´¦æˆ·åˆ é™¤æˆåŠŸ
âœ… [è®¤è¯] æœ¬åœ°çŠ¶æ€å·²æ¸…é™¤
```

### Edge Function ç«¯è°ƒè¯•

åœ¨ Supabase Dashboard çš„ Logs ä¸­æŸ¥çœ‹ï¼š

```
ğŸš€ [åˆ é™¤è´¦æˆ·] å¼€å§‹å¤„ç†è´¦æˆ·åˆ é™¤è¯·æ±‚
ğŸ“ [åˆ é™¤è´¦æˆ·] æ”¶åˆ°è®¤è¯ä»¤ç‰Œ
âœ… [åˆ é™¤è´¦æˆ·] ç”¨æˆ·èº«ä»½éªŒè¯æˆåŠŸ
ğŸ“ [åˆ é™¤è´¦æˆ·] ç”¨æˆ·ID: xxx-xxx-xxx
ğŸ“ [åˆ é™¤è´¦æˆ·] ç”¨æˆ·é‚®ç®±: user@example.com
ğŸ—‘ï¸ [åˆ é™¤è´¦æˆ·] å¼€å§‹åˆ é™¤ç”¨æˆ·è´¦æˆ·...
âœ… [åˆ é™¤è´¦æˆ·] ç”¨æˆ·è´¦æˆ·åˆ é™¤æˆåŠŸ
ğŸ“ [åˆ é™¤è´¦æˆ·] å·²åˆ é™¤ç”¨æˆ·ID: xxx-xxx-xxx
```

## ğŸ§ª æµ‹è¯•æµç¨‹

### 1. åˆ›å»ºæµ‹è¯•è´¦æˆ·

1. åœ¨ iOS åº”ç”¨ä¸­æ³¨å†Œä¸€ä¸ªæµ‹è¯•è´¦æˆ·
2. è®°å½•è´¦æˆ·é‚®ç®±å’Œ ID

### 2. æµ‹è¯•åˆ é™¤æµç¨‹

1. ç™»å½•æµ‹è¯•è´¦æˆ·
2. è¿›å…¥ã€Œä¸ªäººã€é¡µé¢
3. æ»šåŠ¨åˆ°ã€Œå±é™©åŒºåŸŸã€
4. ç‚¹å‡»ã€Œåˆ é™¤è´¦æˆ·ã€
5. ç¡®è®¤ç¬¬ä¸€æ¬¡è­¦å‘Š
6. ç¡®è®¤æœ€ç»ˆåˆ é™¤
7. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—

### 3. éªŒè¯åˆ é™¤ç»“æœ

åœ¨ Supabase Dashboard éªŒè¯ï¼š

1. Authentication â†’ Users - ç¡®è®¤ç”¨æˆ·å·²è¢«åˆ é™¤
2. Table Editor - å¦‚æœæœ‰å…³è”è¡¨ï¼Œç¡®è®¤æ•°æ®å·²è¢«çº§è”åˆ é™¤
3. Edge Functions â†’ Logs - æŸ¥çœ‹åˆ é™¤æ—¥å¿—

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. èº«ä»½éªŒè¯

- Edge Function ä¼šéªŒè¯ç”¨æˆ·çš„ access token
- åªæœ‰è®¤è¯ç”¨æˆ·æ‰èƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·
- ä½¿ç”¨ service role key ç¡®ä¿æœ‰æƒé™åˆ é™¤ç”¨æˆ·

### 2. æ•°æ®å®‰å…¨

- åˆ é™¤æ“ä½œä¸å¯é€†ï¼Œè¯·ç¡®ä¿ç”¨æˆ·å……åˆ†ç†è§£
- å»ºè®®åœ¨åˆ é™¤å‰å¤‡ä»½é‡è¦æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
- è€ƒè™‘å®æ–½ã€Œè½¯åˆ é™¤ã€ç­–ç•¥ï¼ˆä¿ç•™æ•°æ®ä½†æ ‡è®°ä¸ºå·²åˆ é™¤ï¼‰

### 3. çº§è”åˆ é™¤

- ç¡®ä¿æ‰€æœ‰ç›¸å…³è¡¨éƒ½é…ç½®äº†æ­£ç¡®çš„çº§è”åˆ é™¤
- æµ‹è¯•åˆ é™¤æµç¨‹ä»¥éªŒè¯æ‰€æœ‰æ•°æ®éƒ½è¢«æ­£ç¡®æ¸…ç†
- è€ƒè™‘æ˜¯å¦éœ€è¦ä¿ç•™æŸäº›æ•°æ®ï¼ˆå¦‚è®¢å•å†å²ã€è¯„è®ºç­‰ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šEdge Function éƒ¨ç½²å¤±è´¥

**é”™è¯¯**ï¼š`Error deploying function`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤å·²æ­£ç¡®é“¾æ¥åˆ°é¡¹ç›®ï¼š`supabase link --project-ref YOUR_PROJECT_REF`
2. æ£€æŸ¥å‡½æ•°ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
3. ç¡®è®¤ Supabase CLI ç‰ˆæœ¬æ˜¯æœ€æ–°çš„ï¼š`supabase --version`

### é—®é¢˜ 2ï¼šè°ƒç”¨ Edge Function è¿”å› 401

**é”™è¯¯**ï¼š`æœªæˆæƒï¼šæ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ access token æ˜¯æœ‰æ•ˆçš„ï¼ˆæœªè¿‡æœŸï¼‰
2. æ£€æŸ¥ Authorization header æ ¼å¼ï¼š`Bearer <token>`
3. åœ¨ iOS ç«¯é‡æ–°ç™»å½•è·å–æ–°çš„ token

### é—®é¢˜ 3ï¼šç”¨æˆ·åˆ é™¤æˆåŠŸä½†ç›¸å…³æ•°æ®æœªåˆ é™¤

**é”™è¯¯**ï¼šç›¸å…³è¡¨ä¸­çš„æ•°æ®ä»ç„¶å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥å¤–é”®çº¦æŸæ˜¯å¦é…ç½®äº† `ON DELETE CASCADE`
2. æ‰§è¡Œä¸Šè¿°ã€Œé…ç½®æ•°æ®åº“çº§è”åˆ é™¤ã€æ­¥éª¤
3. æ‰‹åŠ¨æ¸…ç†é—ç•™æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰

### é—®é¢˜ 4ï¼šiOS ç«¯è°ƒç”¨å¤±è´¥

**é”™è¯¯**ï¼š`åˆ é™¤è´¦æˆ·å¤±è´¥: Network error`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. ç¡®è®¤ Edge Function å·²æˆåŠŸéƒ¨ç½²
3. æŸ¥çœ‹ Supabase Dashboard çš„ Edge Functions æ—¥å¿—
4. æ£€æŸ¥ Supabase URL æ˜¯å¦æ­£ç¡®

## ğŸ“Š ç›‘æ§å»ºè®®

### 1. è®¾ç½®æ—¥å¿—å‘Šè­¦

åœ¨ Supabase Dashboard ä¸­ï¼š
- ç›‘æ§ Edge Function çš„é”™è¯¯ç‡
- è®¾ç½®åˆ é™¤æ“ä½œçš„é€šçŸ¥
- è·Ÿè¸ªåˆ é™¤é¢‘ç‡

### 2. æ•°æ®åˆ†æ

- è®°å½•åˆ é™¤è´¦æˆ·çš„åŸå› ï¼ˆå¯é€‰ï¼‰
- åˆ†æç”¨æˆ·æµå¤±åŸå› 
- ä¼˜åŒ–äº§å“ä»¥å‡å°‘åˆ é™¤ç‡

## ğŸ‰ å®Œæˆ

é…ç½®å®Œæˆåï¼Œæ‚¨çš„åº”ç”¨å°±æ‹¥æœ‰å®Œæ•´çš„è´¦æˆ·åˆ é™¤åŠŸèƒ½äº†ï¼

**åŠŸèƒ½ç‰¹ç‚¹**ï¼š
âœ… å®‰å…¨çš„èº«ä»½éªŒè¯
âœ… äºŒæ¬¡ç¡®è®¤é˜²æ­¢è¯¯æ“ä½œ
âœ… å®Œæ•´çš„ä¸­æ–‡æ—¥å¿—
âœ… è‡ªåŠ¨çº§è”åˆ é™¤ç›¸å…³æ•°æ®
âœ… å‹å¥½çš„ç”¨æˆ·æç¤º
âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—æˆ– Supabase Dashboard çš„ Logsã€‚
